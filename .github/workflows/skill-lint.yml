# .github/workflows/skill-lint.yml
# Stage 1: Lint & Validate ‚Äî runs on every push touching skills or pipeline
# Target: <30 seconds
# 
# Governance Spec v1.3 ¬ß8.3
# Security runs FIRST ‚Äî fail fast on critical findings.
# Hard-tier checks block the workflow. Warn-tier checks report but don't fail.

name: "Skill Lint & Validate"

on:
  push:
    paths:
      - "skills/**"
      - "pipeline/**"
      - "SKILL.md"
  pull_request:
    paths:
      - "skills/**"
      - "pipeline/**"
      - "SKILL.md"

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install pyyaml tiktoken

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # HARD TIER ‚Äî blocks the workflow on failure
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      # Security runs FIRST ‚Äî fail fast on critical findings
      - name: "üîí Security scan"
        id: security
        run: |
          echo "## üîí Security Scan" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_security.py . 2>&1 | tee security-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Security violations found ‚Äî see output above" >> $GITHUB_STEP_SUMMARY
            cat security-output.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No security violations" >> $GITHUB_STEP_SUMMARY
          fi
          exit $EXIT_CODE

      - name: "üìã Frontmatter validation"
        if: success() || failure()
        id: frontmatter
        run: |
          echo "## üìã Frontmatter" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_frontmatter.py . 2>&1 | tee frontmatter-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Frontmatter violations found" >> $GITHUB_STEP_SUMMARY
            cat frontmatter-output.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All frontmatter valid" >> $GITHUB_STEP_SUMMARY
          fi
          exit $EXIT_CODE

      - name: "üîó Reference integrity (incl. depth check)"
        if: success() || failure()
        id: references
        run: |
          echo "## üîó References" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_references.py . 2>&1 | tee references-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Reference violations found" >> $GITHUB_STEP_SUMMARY
            echo "Checks: file existence, one-level-deep rule, TOC for >100 line files" >> $GITHUB_STEP_SUMMARY
            cat references-output.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All references valid (incl. depth check)" >> $GITHUB_STEP_SUMMARY
          fi
          exit $EXIT_CODE

      - name: "üöß Cross-skill isolation"
        if: success() || failure()
        id: isolation
        run: |
          echo "## üöß Isolation" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_isolation.py . 2>&1 | tee isolation-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Isolation violations ‚Äî specialists referencing other specialists" >> $GITHUB_STEP_SUMMARY
            cat isolation-output.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ No isolation violations" >> $GITHUB_STEP_SUMMARY
          fi
          exit $EXIT_CODE

      - name: "üìè Suite context load ceiling"
        if: success() || failure()
        id: context_load
        run: |
          echo "## üìè Context Load" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_context_load.py . 2>&1 | tee context-load-output.txt
          EXIT_CODE=${PIPESTATUS[0]}
          if [ $EXIT_CODE -ne 0 ]; then
            echo "‚ùå Suite exceeds 5,500 token ceiling" >> $GITHUB_STEP_SUMMARY
            cat context-load-output.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All suites under ceiling" >> $GITHUB_STEP_SUMMARY
          fi
          exit $EXIT_CODE

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # WARN TIER ‚Äî reports findings but does NOT fail the workflow
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      - name: "üéØ Trigger / description quality"
        if: always()
        run: |
          echo "## üéØ Trigger Quality" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_triggers.py . 2>&1 | tee triggers-output.txt || true
          cat triggers-output.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Checks: description length, activation directive, third person, negative boundaries, vocabulary overlap, MCP tool format_" >> $GITHUB_STEP_SUMMARY

      - name: "üí∞ Token budget check"
        if: always()
        run: |
          echo "## üí∞ Token Budgets" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_token_budget.py . 2>&1 | tee budget-output.txt || true
          cat budget-output.txt >> $GITHUB_STEP_SUMMARY

      - name: "‚úçÔ∏è Prose quality"
        if: always()
        run: |
          echo "## ‚úçÔ∏è Prose Quality" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_prose.py . 2>&1 | tee prose-output.txt || true
          cat prose-output.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Checks: filler patterns, well-known concept explanations, temporal references_" >> $GITHUB_STEP_SUMMARY

      - name: "üîß Script quality"
        if: always()
        run: |
          echo "## üîß Script Quality" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/hooks/check_scripts.py . 2>&1 | tee scripts-output.txt || true
          cat scripts-output.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Checks: error handling, documented constants, verbose errors, dependency declarations_" >> $GITHUB_STEP_SUMMARY

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # SUMMARY ‚Äî always runs, aggregates results
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      - name: "üìä Budget report (PRs only)"
        if: always() && github.event_name == 'pull_request'
        run: |
          echo "## üìä Full Budget Report" >> $GITHUB_STEP_SUMMARY
          python3 pipeline/scripts/budget-report.py . >> $GITHUB_STEP_SUMMARY 2>&1 || true

      - name: "Gate: fail if any Hard check failed"
        if: always()
        run: |
          echo ""
          echo "=== Hard Check Results ==="
          echo "Security:       ${{ steps.security.outcome }}"
          echo "Frontmatter:    ${{ steps.frontmatter.outcome }}"
          echo "References:     ${{ steps.references.outcome }}"
          echo "Isolation:      ${{ steps.isolation.outcome }}"
          echo "Context Load:   ${{ steps.context_load.outcome }}"
          echo ""

          FAILED=0
          for step in security frontmatter references isolation context_load; do
            OUTCOME="${{ steps[step].outcome }}" 2>/dev/null || OUTCOME="skipped"
            if [ "$OUTCOME" = "failure" ]; then
              FAILED=1
            fi
          done

          if [ $FAILED -eq 1 ]; then
            echo "‚ùå One or more Hard checks failed. See step summaries above."
            exit 1
          else
            echo "‚úÖ All Hard checks passed."
          fi
