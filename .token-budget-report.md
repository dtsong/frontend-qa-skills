# Token Budget & Self-Check Validation Report

**Date:** 2026-02-14
**Validator:** Skeptic (Red Lens)
**Method:** Characters / 4 (1 token ~ 4 characters)

---

## 1. Token Budget Table

### SKILL.md Files

| File | Chars | Est. Tokens | Budget | Status |
|------|-------|-------------|--------|--------|
| `qa-coordinator/SKILL.md` | 4,375 | 1,093 | 800 | **OVER (+293)** |
| `page-component-mapper/SKILL.md` | 6,089 | 1,522 | 2,000 | PASS |
| `ui-bug-investigator/SKILL.md` | 5,150 | 1,287 | 2,000 | PASS |
| `css-layout-debugger/SKILL.md` | 6,111 | 1,527 | 2,000 | PASS |
| `component-fix-and-verify/SKILL.md` | 5,173 | 1,293 | 2,000 | PASS |
| `regression-test-generator/SKILL.md` | 4,905 | 1,226 | 2,000 | PASS |

### Reference Files (Skill-Specific)

| File | Chars | Est. Tokens | Budget | Status |
|------|-------|-------------|--------|--------|
| `page-component-mapper/references/import-tracing-protocol.md` | 4,896 | 1,224 | 1,500 | PASS |
| `page-component-mapper/references/caching-protocol.md` | 4,095 | 1,023 | 1,500 | PASS |
| `ui-bug-investigator/references/rendering-state-checks.md` | 4,484 | 1,121 | 1,500 | PASS |
| `ui-bug-investigator/references/event-handling-checks.md` | 4,591 | 1,147 | 1,500 | PASS |
| `ui-bug-investigator/references/data-flow-checks.md` | 5,246 | 1,311 | 1,500 | PASS |
| `css-layout-debugger/references/layout-model-checks.md` | 5,523 | 1,380 | 1,500 | PASS |
| `css-layout-debugger/references/stacking-viewport-checks.md` | 5,971 | 1,492 | 1,500 | PASS (8 tokens margin) |
| `css-layout-debugger/references/tailwind-conflict-map.md` | 5,941 | 1,485 | 1,500 | PASS (15 tokens margin) |
| `component-fix-and-verify/references/verification-commands.md` | 3,864 | 966 | 1,500 | PASS |
| `regression-test-generator/references/vitest-rtl-patterns.md` | 4,090 | 1,022 | 1,500 | PASS |
| `regression-test-generator/references/playwright-patterns.md` | 4,712 | 1,178 | 1,500 | PASS |

### Reference Files (Shared)

| File | Chars | Est. Tokens | Budget | Status |
|------|-------|-------------|--------|--------|
| `shared-references/frontend-qa/test-generation-patterns.md` | 4,160 | 1,040 | 1,500 | PASS |
| `shared-references/frontend-qa/component-analysis-patterns.md` | 5,061 | 1,265 | 1,500 | PASS |
| `shared-references/frontend-qa/nextjs-app-router-gotchas.md` | 4,189 | 1,047 | 1,500 | PASS |
| `shared-references/frontend-qa/css-debugging-checklist.md` | 4,859 | 1,214 | 1,500 | PASS |

### Summary

| Category | Files | PASS | OVER | Near-Budget (>90%) |
|----------|-------|------|------|-------------------|
| Coordinator SKILL.md (800) | 1 | 0 | **1** | -- |
| Specialist SKILL.md (2,000) | 5 | 5 | 0 | 0 |
| Skill-specific references (1,500) | 11 | 11 | 0 | 2 |
| Shared references (1,500) | 4 | 4 | 0 | 0 |
| **Total** | **21** | **20** | **1** | **2** |

**Near-budget alert:** `stacking-viewport-checks.md` (1,492/1,500 = 99.5%) and `tailwind-conflict-map.md` (1,485/1,500 = 99.0%) are within budget but have almost no margin. Any additions to these files would breach the budget.

---

## 2. Self-Check Enforcement Results

### A. No Background Explanations (Specialist/Reference Layers)

**PASS** -- No specialist SKILL.md or reference file contains "Background", "Overview", "Introduction", "Philosophy", "What is", or "About" sections. No files begin with "This skill provides..." or similar preamble.

### B. No Duplicate Content Across Files

**WARNING** -- Two areas of content overlap detected.

**Overlap 1: Import tracing methodology**
- `page-component-mapper/references/import-tracing-protocol.md` contains the detailed protocol
- `shared-references/frontend-qa/component-analysis-patterns.md` contains a summary version of the same steps (tsconfig resolution, barrel handling, depth limits, boundary detection)
- The two files share structural concepts but differ in detail level. The shared reference summarizes what the skill-specific reference expands on.
- **Risk:** Claude may load both files in the same session (if the coordinator or mapper references both), consuming ~2,500 tokens for overlapping content.
- **Fix:** Replace the "Import Tracing Methodology" section of `component-analysis-patterns.md` with a one-line pointer: `For import tracing protocol, see page-component-mapper/references/import-tracing-protocol.md.`

**Overlap 2: Test generation annotations**
- `regression-test-generator/SKILL.md` contains the GUARDS AGAINST template and anti-brittleness rules inline
- `shared-references/frontend-qa/test-generation-patterns.md` contains the same template and rules
- **Risk:** Moderate -- these files are unlikely to be loaded simultaneously (the SKILL.md loads the reference, not vice versa). The duplication is between a procedure file and a reference file.
- **Fix:** Remove the anti-brittleness rules list from the SKILL.md and replace with: `Apply anti-brittleness rules from shared-references/frontend-qa/test-generation-patterns.md.` Keep the GUARDS AGAINST template in the SKILL.md since it is part of the procedure (showing what to generate).

### C. Every Checklist Item Fits on One Line

**FAIL** -- 33 checklist items exceed 200 characters across 5 reference files.

| File | Items >200 chars | Worst Item (chars) |
|------|------------------|--------------------|
| `css-layout-debugger/references/stacking-viewport-checks.md` | 17 | 308 |
| `css-layout-debugger/references/layout-model-checks.md` | 10 | 302 |
| `ui-bug-investigator/references/event-handling-checks.md` | 3 | 243 |
| `ui-bug-investigator/references/data-flow-checks.md` | 2 | 229 |
| `ui-bug-investigator/references/rendering-state-checks.md` | 1 | 215 |

**Worst offenders (>250 chars):**
1. `stacking-viewport-checks.md` -- "Check: stacking context created unintentionally by `transform`, `filter`, `opacity < 1`, `will-change`, `mix-blend-mode`, `isolation: isolate`, `contain: paint/layout`..." (308 chars)
2. `layout-model-checks.md` -- "Check: `position: sticky` fails -- common causes: (1) no scrollable ancestor, (2) ancestor has `overflow: hidden`..." (302 chars)
3. `layout-model-checks.md` -- "Check: percentage-based positioning (`top: 50%`, `left: 50%`) without `transform: translate(-50%, -50%)`..." (280 chars)
4. `stacking-viewport-checks.md` -- "Check: `z-index` competing across different stacking contexts..." (278 chars)
5. `stacking-viewport-checks.md` -- "Check: animation on `width`, `height`, `top`, `left`, `margin`, `padding`..." (266 chars)
6. `stacking-viewport-checks.md` -- "Check: `grid-cols-*` without responsive variants..." (251 chars)

**Fix:** Split long items into detection line + detail line:
```markdown
- Check: `position: sticky` fails
  Causes: (1) no scrollable ancestor (2) ancestor overflow:hidden/auto (3) no top/bottom value
  Tailwind: need both `sticky` and `top-0`
```

This also benefits the near-budget files (`stacking-viewport-checks.md` at 99.5%) because splitting does not add characters -- it reformats existing content.

### D. Decision Points Are Inline

**PASS** -- All 4 inter-file reference pointers use the inline pattern:
- `css-layout-debugger/SKILL.md:47` -- "**If Tailwind detected:** read `references/tailwind-conflict-map.md`"
- `regression-test-generator/SKILL.md:35` -- "If async server component -> read `references/playwright-patterns.md`"
- `regression-test-generator/SKILL.md:36` -- "Otherwise -> read `references/vitest-rtl-patterns.md`"
- `page-component-mapper/SKILL.md:62` -- "For detailed resolution rules and edge cases, read `references/import-tracing-protocol.md`"

Zero prose-style decision descriptions found.

### E. Output Examples Are <=15 Lines

**FAIL** -- 3 SKILL.md files have output examples exceeding 15 lines.

| File | Line | Block Size | Content |
|------|------|-----------|---------|
| `page-component-mapper/SKILL.md` | 110 | 17 lines | ComponentMap JSON example |
| `ui-bug-investigator/SKILL.md` | 79 | 18 lines | DiagnosisReport output format |
| `css-layout-debugger/SKILL.md` | 112 | 16 lines | CSS diagnosis output format |

**Fix for each:**
1. `page-component-mapper/SKILL.md` (17 -> 15): Remove the `cachedFiles` array line and the comment explaining it. Move that detail to `references/caching-protocol.md`.
2. `ui-bug-investigator/SKILL.md` (18 -> 15): Merge the SKIPPED section with the summary line into 2 lines instead of 4. Example: combine `### SKIPPED ({count} categories)` and the line under it into one line.
3. `css-layout-debugger/SKILL.md` (16 -> 15): Remove one of the two CLEAR example lines (one example is sufficient to establish the pattern).

### F. Reference Pointers Use Exact File Paths

**PASS** -- All reference pointers use exact relative paths. No vague references found.

---

## 3. Issues Requiring Action

### Must Fix

| # | Issue | File(s) | Action | Impact |
|---|-------|---------|--------|--------|
| 1 | **qa-coordinator/SKILL.md exceeds 800 token budget** (1,093 actual) | 1 file | Trim ~1,172 characters (~293 tokens). Candidates: compress Pipeline Execution phase descriptions (Phases 1-4 have redundant structure), remove Skill Registry table (paths are already in the phase descriptions), tighten classification table. | Budget compliance |
| 2 | **3 output examples exceed 15 lines** | 3 SKILL.md files | Trim 1-3 lines each per fixes described above. | Self-check compliance |
| 3 | **33 checklist items exceed single-line length** | 5 reference files | Split long items into Check + detail sub-lines. No net character increase needed. | Self-check compliance, readability |

### Should Fix

| # | Issue | File(s) | Action | Impact |
|---|-------|---------|--------|--------|
| 4 | Import tracing content overlap | `component-analysis-patterns.md` + `import-tracing-protocol.md` | Replace summary section with pointer to detailed reference | ~500 tokens saved, eliminates potential double-load |
| 5 | Test generation annotation overlap | `regression-test-generator/SKILL.md` + `test-generation-patterns.md` | Move anti-brittleness rules to reference-only | ~200 tokens saved from SKILL.md |

### Monitor (No Action Now)

| # | Issue | File(s) | Note |
|---|-------|---------|------|
| 6 | `stacking-viewport-checks.md` at 99.5% budget | 1 file | Any additions will breach. Consider splitting into two files if more checks are needed. |
| 7 | `tailwind-conflict-map.md` at 99.0% budget | 1 file | Same caution. |

---

## 4. Worst-Case Context Cost Validation

Per the design doc, worst-case per pipeline step should be <=5,000 tokens:

| Pipeline Step | Coordinator | Specialist | Reference | Shared Ref | Total | Status |
|---------------|-------------|-----------|-----------|------------|-------|--------|
| MAP | 1,093* | 1,522 | 1,224 (import-tracing) | -- | 3,839 | PASS |
| DIAGNOSE (UI) | 1,093* | 1,287 | 1,311 (data-flow) | 1,047 (app-router) | 4,738 | PASS |
| DIAGNOSE (CSS) | 1,093* | 1,527 | 1,492 (stacking) | 1,214 (css-checklist) | 5,326 | **OVER** |
| FIX | 1,093* | 1,293 | 966 (verification) | -- | 3,352 | PASS |
| TEST | 1,093* | 1,226 | 1,178 (playwright) | 1,040 (test-patterns) | 4,537 | PASS |

*Using current over-budget coordinator size. After trimming to 800, all steps pass the 5,000 target.

**Note:** The CSS DIAGNOSE step at 5,326 exceeds 5,000 even with a trimmed coordinator (800 + 1,527 + 1,492 + 1,214 = 5,033). This is marginal but suggests that the CSS debugger should avoid loading both a reference file AND a shared reference simultaneously. The SKILL.md should route to specific reference files per phase, not load all at once.
